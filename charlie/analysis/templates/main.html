{% extends "base.html" %}

{% block staticfiles %}
{% load staticfiles %}
    <link rel="stylesheet" type="text/css" href="{% static 'analysis/css/bootstrap.min.css' %}" />
    <link rel="stylesheet" type="text/css" href="{% static 'analysis/css/sidebar.css' %}" />
    <link rel="stylesheet" type="text/css" href="{% static 'analysis/css/simple-sidebar.css' %}" />
    <link rel="stylesheet" type="text/css" href="{% static 'analysis/css/cloud-page.css' %}" />
    <link rel="stylesheet" type="text/css" href="https://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.4/css/jquery.dataTables.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/plug-ins/9dcbecd42ad/integration/jqueryui/dataTables.jqueryui.css">

    <script src ="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.4/js/jquery.dataTables.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/plug-ins/9dcbecd42ad/integration/jqueryui/dataTables.jqueryui.js"></script>
    <script src ="http://code.highcharts.com/highcharts.js"></script>
    <script src ="{% static 'analysis/js/papaparse.min.js' %}"></script>
    <script src ="{% static 'analysis/js/charlie.js' %}"></script>
    <script src ="{% static 'analysis/js/main.js' %}"></script>
    <script src ="{% static 'analysis/js/bootstrap.min.js' %}"></script>
    <script src ="{% static 'analysis/js/tabularSMS.js' %}"></script>
    <script src ="{% static 'analysis/js/inputParsing.js' %}"></script>
    <script src ="{% static 'analysis/js/jput.min.js' %}"></script>
    <script src ="{% static 'analysis/js/charlie.js' %}"></script>
    <script src ="{% static 'analysis/js/jquery.cookie.js' %}"></script>
    <script src ="{% static 'analysis/js/jquery.awesomeCloud-0.2.min.js' %}"></script>
    <script src ="{% static 'analysis/js/tagcanvas.min.js' %}"></script>
    <script src ="{% static 'analysis/js/sidebar.js' %}"></script>
    <script src ="{% static 'analysis/js/wordcloud.js' %}"></script>
{% endblock %}



{%block content%}
<div id="wrapper">
    <!-- Sidebar -->
    {%block sidebar%}
    <div id="sidebar-wrapper">
        <ul class="sidebar-nav">
			<div class="sidebar-link-container">
				<a href={%url 'dashboard' %} class="sidebar-link">
					<span class="glyphicon glyphicon-home" aria-hidden="true"></span>
				</a>
                <!-- View Traversal: Possibly a different attribute to simplify design -->
				<a class="sidebar-link" switch-view="page_prev">
					<span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
				</a>
				<a class="sidebar-link" switch-view="page_for">
					<span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
				</a>
			</div>
            <div class="sidebar-link-container">
                <a class="sidebar-link" switch-view="page_cloudmap">
                    <span class="glyphicon glyphicon-cloud" aria-hidden="true"></span>
                </a>
                <a class="sidebar-link" switch-view="page_charts">
                    <span class="glyphicon glyphicon-adjust" aria-hidden="true"></span>
                </a>
                <a class="sidebar-link" switch-view="page_text">
                    <span class="glyphicon glyphicon-th-list" aria-hidden="true"></span>
                </a>
            </div>
            <li id='li_filters'>
                <a href="#" id="filters">Filters</a>
            </li>
            <li>
                <a href="#" id="linkers">Linkers</a>
            </li>
        </ul>
    </div>
    {%endblock%}
    <!-- /#sidebar-wrapper -->

    <!-- Page Content -->
    <div id="page-content-wrapper">
        <div class="container-fluid">
            <div id="views">
                <div class="view" id="page_cloudmap">
					<div id="cloud_question">{{title}}</div>
					<div id="canvas_container">
						<canvas id="cloud_canvas" width="600px" height="600px"/>
                        </canvas>
					</div>
					<div id="cloud_tags"/>
					</div>
                </div>
                <div class="view" id="page_text">
                    {{table}}
                    <br/>
                </div>

                <div class="view" id="page_charts">
                    <div class="text-vertical-center" id="pie_chart">
                    {{pie_chart}}
                    </div>
                    <div class="text-vertical-center" id="column_chart">
                    {{column_chart}}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {%endblock%}
    <!-- /#page-content-wrapper -->
</div>
<!-- /#wrapper -->


{%block scripts%}
<script>
var data_raw;
var data_wordfreq;
var data_filtered;
var data_countries;
var data_rstations;
var data_answers;
var data_question;
var data_options;
var table;

// global state variables
var WINDOW = {
    HOME: {id: 'page_dashboard'},
    UPLOAD: {id: 'page_upload'},
    CHART: {id: 'page_charts'},
    CLOUD: {id: 'page_cloudmap'},
    LIST: {id: 'page_text'}
}

var CTR_WINDOW;
var CTR_TABLE_INITIALIZED;

CTR_TABLE_INITIALIZED = false;
data_raw = {{data_raw | safe}};
data_filtered = data_raw
data_wordfreq = {{word_freq | safe }}
data_countries = {{data_countries | safe}}
data_rstations = {{data_rstations | safe}}

drawCloudMap(data_wordfreq, '#cloud_tags')
renderSideBars({{sidebar_filters | safe}}, '#li_filters')
CTR_WINDOW = WINDOW.CHART;
$("#wrapper").toggleClass("toggled");
switchView();


        document.getElementById("cloud_tags").addEventListener("click",
            function(e){
                word = e.target.id
                table.search(word).draw()
                CTR_WINDOW = WINDOW.LIST
                switchView()
        });
		
		$("#menu-toggle").click(function(e) {
			e.preventDefault();
			$("#wrapper").toggleClass("toggled");
		});
		
		$('[switch-view]').click(function (e) {
			e.preventDefault();
			var x = $(this).attr('switch-view');
			if(x == 'page_cloudmap'){
				CTR_WINDOW = WINDOW.CLOUD
			}
            else if(x == 'page_charts'){
                CTR_WINDOW = WINDOW.CHART
            }
			else if(x == 'page_text'){
				CTR_WINDOW  = WINDOW.LIST
			}
			else if(x == 'page_prev'){
				if (CTR_WINDOW == WINDOW.LIST){CTR_WINDOW = WINDOW.CLOUD}
			}
			else if(x == 'page_for'){
				if (CTR_WINDOW == WINDOW.UPLOAD && CTR_formatValid){CTR_WINDOW = WINDOW.CLOUD}
                if (CTR_WINDOW == WINDOW.CLOUD){CTR_WINDOW = WINDOW.LIST}
			}
			switchView()
		});
        /* 
            to change the page based on the value of CTR_WINDOW
        */
        function switchView(){
            //TODO: precise FSM specification
            $(' .view').hide();
            $('#' + CTR_WINDOW.id).show();
/*
            if(CTR_WINDOW == WINDOW.CHART){
                $('#filters').hide()
            }
            else{
                $('#filters').show()
            }
*/
        }

        var csrftoken = $.cookie('csrftoken');

        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }

        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });


        function create_post() {
            console.log("create post is working!") // sanity check
            $.ajax({
                url : "update/", // the endpoint
                type : "POST", // http method
                data : { the_post : "haha" }, // data sent with the post request

                // handle a successful response
                success : function(json) {
                    $('#post-text').val(''); // remove the value from the input
                    console.log(json); // log the returned json to the console
                    console.log("success"); // another sanity check
                },

                // handle a non-successful response
                error : function(xhr,errmsg,err) {
                    $('#results').html("<div class='alert-box alert radius' data-alert>Oops! We have encountered an error: "+errmsg+
                        " <a href='#' class='close'>&times;</a></div>"); // add the error to the dom
                    console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
                }
            });
        };

    function renderSideBars(filters, sidebar_id){
    console.log("being called")
    $('li_filters').append("Countries:<br>");
        for(var i = 0; i < filters.countries.length; i++) {
            var name = filters.countries[i];
            var box = $('<input/>').attr({
                type: "checkbox",
                onclick: "OnChangeCountry(this)",
                checked: "checked",
                value: name
        });
        console.log(box);
        $(sidebar_id).append(box);
        $(sidebar_id).append(" " + name + "<br>");
    }
    $(sidebar_id).append("Stations:<br>");
    for(var i = 0; i < filters.stations.length; i++) {
        var name = filters.stations[i];
        var box = $('<input/>').attr({
            type: "checkbox",
            onclick: "OnChangeStation(this)",
            checked: "checked",
            value: name
        });
        $(sidebar_id).append(box);
        $(sidebar_id).append(" " + name + "<br>");
    }
    }
    </script>

    {%endblock%}
