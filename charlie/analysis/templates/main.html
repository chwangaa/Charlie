<!DOCTYPE>
<html>

<head>
		{% load staticfiles %}

	<link rel="stylesheet" type="text/css" href="{% static 'analysis/css/bootstrap.min.css' %}" />
	<link rel="stylesheet" type="text/css" href="{% static 'analysis/css/sidebar.css' %}" />
	<link rel="stylesheet" type="text/css" href="{% static 'analysis/css/simple-sidebar.css' %}" />
	<link rel="stylesheet" type="text/css" href="{% static 'analysis/css/cloud-page.css' %}" />
	<link rel="stylesheet" type="text/css" href="https://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.4/css/jquery.dataTables.css">
	<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/plug-ins/9dcbecd42ad/integration/jqueryui/dataTables.jqueryui.css">


    <script src ="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.4/js/jquery.dataTables.js"></script>
	<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/plug-ins/9dcbecd42ad/integration/jqueryui/dataTables.jqueryui.js"></script>
    <script src ="http://code.highcharts.com/highcharts.js"></script>
    <script src ="{% static 'analysis/js/papaparse.min.js' %}"></script>
    <script src ="{% static 'analysis/js/charlie.js' %}"></script>
    <script src ="{% static 'analysis/js/main.js' %}"></script>
    <script src ="{% static 'analysis/js/bootstrap.min.js' %}"></script>
    <script src ="{% static 'analysis/js/tabularSMS.js' %}"></script>
    <script src ="{% static 'analysis/js/sidebar.js' %}"></script>
    <script src ="{% static 'analysis/js/inputParsing.js' %}"></script>
    <script src ="{% static 'analysis/js/jput.min.js' %}"></script>
    <script src ="{% static 'analysis/js/charlie.js' %}"></script>
    <script src ="{% static 'analysis/js/jquery.awesomeCloud-0.2.min.js' %}"></script>
    <script src ="{% static 'analysis/js/tagcanvas.min.js' %}"></script>
    <script src ="{% static 'analysis/js/wordcloud.js' %}"></script>
    
    <title>Group Charlie</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
</head>

<body>

<div id="wrapper">
    <!-- Sidebar -->
    <div id="sidebar-wrapper">
        <ul class="sidebar-nav">
			<div class="sidebar-link-container">
				<a href={%url 'dashboard' %} class="sidebar-link">
					<span class="glyphicon glyphicon-home" aria-hidden="true"></span>
				</a>
                <!-- View Traversal: Possibly a different attribute to simplify design -->
				<a class="sidebar-link" switch-view="page_prev">
					<span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
				</a>
				<a class="sidebar-link" switch-view="page_for">
					<span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
				</a>
			</div>
            <div class="sidebar-link-container">
                <a class="sidebar-link" switch-view="page_cloudmap">
                    <span class="glyphicon glyphicon-cloud" aria-hidden="true"></span>
                </a>
                <a class="sidebar-link" switch-view="page_charts">
                    <span class="glyphicon glyphicon-adjust" aria-hidden="true"></span>
                </a>
                <a class="sidebar-link" switch-view="page_text">
                    <span class="glyphicon glyphicon-th-list" aria-hidden="true"></span>
                </a>
            </div>
            <ul id='filters'>
                <li id='li_filters'>
                    <a href="#" id="filters">Filters</a>
                </li>
                <li>
                    <a href="#" id="linkers">Advanced Filters</a>
                </li>
            </ul>
        </ul>
    </div>
    <!-- /#sidebar-wrapper -->

    <!-- Page Content -->
    <div id="page-content-wrapper">
        <div class="container-fluid">
            <div id="views">
                <div class="view" id="page_cloudmap">
					<div id="cloud_question">{{title}}</div>
					</br>
					<div id="canvas_container">
						<canvas id="cloud_canvas" width="600px" height="600px"/>
					</div>
					<div id="cloud_tags"/>
					</div>
                </div>
                <div class="view" id="page_text">
                    <table id='pretty', class="table table-striped table-bordered">
                    <p id="displayWord" align="justify"></p>
                        <thead>
                        <tr>
                            <th>Index</th>
                            <th>Country</th>
                            <th>RStation</th>
                            <th>SMS</th>
                            <th>Opinion</th>
                        </tr>
                    </thead>
                    </table>
                    <br/>
                </div>

                <div class="view" id="page_charts">
                    <div class="text-vertical-center" id="pie_chart">
                    </div>
                    <div class="text-vertical-center" id="column_chart">
                    </div>
                </div>

            </div>
        </div>
    </div>
    <!-- /#page-content-wrapper -->
</div>
<!-- /#wrapper -->

<script>
var data_raw;
var data_wordfreq;
var data_filtered;
var data_countries;
var data_rstations;
var data_answers;
var data_question;
var data_options;
var table;

// global state variables
var WINDOW = {
    HOME: {id: 'page_dashboard'},
    UPLOAD: {id: 'page_upload'},
    CHART: {id: 'page_charts'},
    CLOUD: {id: 'page_cloudmap'},
    LIST: {id: 'page_text'}
}

var CTR_WINDOW;
var CTR_TABLE_INITIALIZED;

CTR_TABLE_INITIALIZED = false;
data_raw = {{data_raw | safe}};
data_filtered = data_raw
data_wordfreq = {{word_freq | safe }}
data_countries = {{data_countries | safe}}
data_rstations = {{data_rstations | safe}}

window.addEventListener('resize', resizeCanvas, false);
resizeCanvas();

var chart = new Highcharts.Chart({
        chart: {
            renderTo: "pie_chart",
            type: "pie"
        },

        title: {
            text: "{{ chart.title }}"
        },

        plotOptions: {
            pie: {
                allowPointSelect: true,
                dataLabels:{
                    enabled: true,
                    format: '<b>{point.name}</b>: {point.percentage:.1f} %',
                }
            },
            series: {
                cursor: 'pointer',
                point: {
                    events: {
                        click: function () {
                            var opinion = this.name
                            displayTable(opinion)
                        }
                    }
                }
            }
        },

        series: [{
            data: {{chart.data | safe}},
            name: "{{chart.data_name}}"
        }]


});

var chart = new Highcharts.Chart({
        chart: {
            renderTo: "column_chart",
            type: "column"
        },

        title: {
            text: "{{ column_chart.title }}"
        },
        xAxis: {
            categories: {{column_chart.countries | safe}}
        },
        yAxis: {
            min: 0,
            title: {
                text: '#Text Message'
            },
            stackLabels: {
                enabled: true,
                style: {
                    fontWeight: 'bold',
                    color: (Highcharts.theme && Highcharts.theme.textColor) || 'gray'
                }
            }
        },
        legend: {
            align: 'right',
            x: -30,
            verticalAlign: 'top',
            y: 25,
            floating: true,
            backgroundColor: (Highcharts.theme && Highcharts.theme.background2) || 'white',
            borderColor: '#CCC',
            borderWidth: 1,
            shadow: false
        },
        tooltip: {
            formatter: function () {
                return '<b>' + this.x + '</b><br/>' +
                    this.series.name + ': ' + this.y + '<br/>' +
                    'Total: ' + this.point.stackTotal;
            }
        },
        plotOptions: {
            column: {
                stacking: 'normal',
                dataLabels: {
                    enabled: true,
                    color: (Highcharts.theme && Highcharts.theme.dataLabelsColor) || 'white',
                    style: {
                        textShadow: '0 0 3px black'
                    }
                }
            }
        },

        series: {{column_chart.data |safe }}

});


drawCloudMap(data_wordfreq, '#cloud_tags')
updateList(data_filtered)
renderSideBars({{sidebar_filters | safe}}, '#li_filters')
$("#wrapper").toggleClass("toggled");
CTR_WINDOW = WINDOW.CHART;
switchView();


        document.getElementById("cloud_tags").addEventListener("click",
            function(e){
                document.getElementById("displayWord").innerHTML = "You clicked on "+e.target.id;
                data = findSMS(e.target.id, data_raw)
                updateList(data)
                CTR_WINDOW = WINDOW.LIST
                switchView()
        });
		
		$("#menu-toggle").click(function(e) {
			e.preventDefault();
			$("#wrapper").toggleClass("toggled");
		});
		
		$('[switch-view]').click(function (e) {
			e.preventDefault();
			var x = $(this).attr('switch-view');
			if(x == 'page_cloudmap'){
				CTR_WINDOW = WINDOW.CLOUD
			}
            else if(x == 'page_charts'){
                CTR_WINDOW = WINDOW.CHART
            }
			else if(x == 'page_text'){
				CTR_WINDOW  = WINDOW.LIST
			}
			else if(x == 'page_prev'){
				if (CTR_WINDOW == WINDOW.LIST){CTR_WINDOW = WINDOW.CLOUD}
			}
			else if(x == 'page_for'){
				if (CTR_WINDOW == WINDOW.UPLOAD && CTR_formatValid){CTR_WINDOW = WINDOW.CLOUD}
                if (CTR_WINDOW == WINDOW.CLOUD){CTR_WINDOW = WINDOW.LIST}
			}
			switchView()
		});
        /* 
            to change the page based on the value of CTR_WINDOW
        */
        function switchView(){
            //TODO: precise FSM specification
            $(' .view').hide();
            $('#' + CTR_WINDOW.id).show();
            if(CTR_WINDOW == WINDOW.CHART){
                $('#filters').hide()
            }
            else{
                $('#filters').show()
            }
        }
	</script>
</body>
</html>
